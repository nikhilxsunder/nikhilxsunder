name: Render README SVG assets

on:
  workflow_dispatch:
  schedule:
    - cron: "17 6 * * *"  # daily

permissions:
  contents: write

concurrency:
  group: render-readme-svgs
  cancel-in-progress: false

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure output directory
        run: mkdir -p .github/assets/readme

      - name: Fetch GitHub Stats + Top Languages SVGs
        shell: bash
        run: |
          set -euo pipefail

          # 1) Main stats card
          curl -fsSL --retry 5 --retry-delay 2 \
            -H "Accept: image/svg+xml" \
            "https://github-readme-stats.vercel.app/api?username=nikhilxsunder&show_icons=true&theme=tokyonight&rank_icon=github" \
            -o ".github/assets/readme/github-stats.svg"

          # sanity check
          if ! head -n 5 ".github/assets/readme/github-stats.svg" | grep -qi "<svg"; then
            echo "github-stats.svg does not look like SVG:"
            sed -n '1,40p' ".github/assets/readme/github-stats.svg"
            exit 1
          fi

          # 2) Top langs donut
          curl -fsSL --retry 5 --retry-delay 2 \
            -H "Accept: image/svg+xml" \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=nikhilxsunder&layout=donut&theme=tokyonight" \
            -o ".github/assets/readme/top-langs.svg"

          if ! head -n 5 ".github/assets/readme/top-langs.svg" | grep -qi "<svg"; then
            echo "top-langs.svg does not look like SVG:"
            sed -n '1,40p' ".github/assets/readme/top-langs.svg"
            exit 1
          fi

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet -- .github/assets/readme; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .github/assets/readme
          git commit -m "chore(readme): refresh stats SVG assets"
          git push
