name: Render pinned repo cards (SVG)

on:
  workflow_dispatch:
  schedule:
    # Daily at 06:17 UTC (pick anything)
    - cron: "17 6 * * *"

permissions:
  contents: write

concurrency:
  group: render-pins
  cancel-in-progress: false

jobs:
  render:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pin:
          - owner: nikhilsunder
            repo: fedfred
            out: fedfred.svg
          - owner: nikhilsunder
            repo: edgar-sec
            out: edgar-sec.svg
          - owner: erskordi
            repo: Autonomous_Fed
            out: Autonomous_Fed.svg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure output directory
        run: mkdir -p .github/assets/pins

      - name: Fetch SVG
        shell: bash
        run: |
          set -euo pipefail

          OWNER="${{ matrix.pin.owner }}"
          REPO="${{ matrix.pin.repo }}"
          OUT=".github/assets/pins/${{ matrix.pin.out }}"

          # GitHub Readme Stats "pin" card endpoint
          URL="https://github-readme-stats.vercel.app/api/pin/?username=${OWNER}&repo=${REPO}&theme=tokyonight&cache_seconds=86400&v=1"

          # Fetch as SVG; fail on non-200; retry a bit for transient issues
          curl -fsSL --retry 5 --retry-delay 2 \
            -H "Accept: image/svg+xml" \
            "${URL}" \
            -o "${OUT}"

          # Sanity check: ensure we got SVG, not HTML error page
          if ! head -n 5 "${OUT}" | grep -qi "<svg"; then
            echo "Output does not look like SVG. First 40 lines:"
            sed -n '1,40p' "${OUT}"
            exit 1
          fi

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet -- .github/assets/pins; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .github/assets/pins
          git commit -m "chore(readme): refresh pinned repo SVG cards"
          git push
